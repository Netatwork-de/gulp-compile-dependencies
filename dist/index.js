'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.executeGulp = executeGulp;
exports.executeJspm = executeJspm;
exports.executeNpm = executeNpm;

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { return step("next", value); }, function (err) { return step("throw", err); }); } } return step("next"); }); }; }

let Promise = require('rsvp').Promise;
let asp = require('rsvp').denodeify;
let fs = require('graceful-fs');
let path = require('path');
let gutil = require('gulp-util');
let spawn = require('child_process').spawn;

let dependencyPath = 'jspm_packages/local';

let getPackageObject = function () {
	var ref = _asyncToGenerator(function* (packageFile) {
		try {
			let lookupJSON = yield asp(fs.readFile)(packageFile);
			return JSON.parse(lookupJSON.toString());
		} catch (e) {
			if (e.code == 'ENOENT' || e instanceof SyntaxError) return { notfound: true };
			throw e;
		}
	});

	return function getPackageObject(_x) {
		return ref.apply(this, arguments);
	};
}();

function fileExists(filepath) {
	if (!filepath) return false;

	try {
		return fs.statSync(filepath).isFile();
	} catch (e) {
		return false;
	}
}

let processDependency = function () {
	var ref = _asyncToGenerator(function* (packagePath, options) {
		let packageName = packagePath.substring(0, packagePath.indexOf('@'));
		gutil.log("Compiling package", gutil.colors.yellow(packageName));

		let project = yield getPackageObject(path.resolve('..', path.join(packageName, 'package.json')));
		let projectPath = path.resolve(path.join("..", packageName));

		let npmInstall = options && options.npmInstall || true;
		let jspmInstall = options && options.jspmInstall || true;
		let gulpBuild = options && options.gulpBuild || true;

		if (npmInstall) {
			yield executeNpm(projectPath, "install");
		}

		let isJspmPresent = project.devDependencies !== undefined && project.devDependencies["jspm"] != null;
		if (jspmInstall && isJspmPresent) {
			gutil.log(gutil.colors.yellow("jspm"), "is configured in this package. Running", gutil.colors.yellow("jspm install"));
			yield executeJspm(projectPath);
		}

		if (gulpBuild && fileExists(path.join(projectPath, "gulpfile.js"))) {
			gutil.log(gutil.colors.yellow("gulp"), "is configured in this package. Running", gutil.colors.yellow("gulp build"));
			yield executeGulp(projectPath);
		}
	});

	return function processDependency(_x2, _x3) {
		return ref.apply(this, arguments);
	};
}();

function executeGulp(packagePath, tasks) {
	gutil.log("Processing", gutil.colors.yellow("gulp"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("gulp", packagePath, tasks || ["build"]);
}

function executeJspm(packagePath) {
	gutil.log("Processing", gutil.colors.yellow("jspm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("jspm", packagePath || path.resolve("."), ["install"]);
}

function executeNpm(packagePath, action) {
	gutil.log("Processing", gutil.colors.yellow("npm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("npm", packagePath || path.resolve("."), [action || "install"]);
}

function spawnProcess(command, workingDirectory, args) {
	let runningOnWindows = /^win/.test(process.platform);
	let nodeModulesPath = path.join(workingDirectory, 'node_modules', '.bin');
	let envCopy = {};
	for (let e in process.env) envCopy[e] = process.env[e];

	if (runningOnWindows) {
		envCopy.Path += ';' + nodeModulesPath;
	} else {
		envCopy.PATH += ':' + nodeModulesPath;
	}

	let opts = {
		cwd: workingDirectory,
		env: envCopy,
		stdio: 'inherit',
		stderr: 'inherit'
	};
	let commandToExecute = command;

	if (runningOnWindows) {
		args = ['/s', '/c', command + ".cmd"].concat(args);
		commandToExecute = 'cmd';

		opts.windowsVerbatimArguments = true;
	}

	return new Promise((resolve, reject) => {
		let proc = spawn(commandToExecute, args, opts);
		proc.on('close', function (code) {
			let error;

			if (code == 0) {
				resolve();
				return;
			}
			error = new gutil.PluginError(`${ command } on ${ packagePath } returned ${ code }`);
			reject(error);
		});
	});
}

function isDirectory(fileName) {
	let filePath = path.resolve(dependencyPath, fileName);
	return fs.lstatSync(filePath).isDirectory();
}

let getLocalDependencies = function () {
	var ref = _asyncToGenerator(function* () {
		let packageConfig = yield getPackageObject("package.json");

		if (!packageConfig.jspm || !packageConfig.jspm.dependencies) throw "package.json does have jspm configured.";

		let localDepedencies = [];

		var dependencies = packageConfig.jspm.dependencies;
		for (let dependency in dependencies) {
			var value = dependencies[dependency];
			if (value.indexOf("local:") == 0) {
				localDepedencies.push(value.substring("local:".length));
			}
		}
		return localDepedencies;
	});

	return function getLocalDependencies() {
		return ref.apply(this, arguments);
	};
}();

let buildDependencies = exports.buildDependencies = function () {
	var ref = _asyncToGenerator(function* (options) {
		gutil.log("Building local dependencies");
		let dependencies = yield getLocalDependencies();
		for (let entry of dependencies) {
			yield processDependency(entry, options);
		}
	});

	return function buildDependencies(_x4) {
		return ref.apply(this, arguments);
	};
}();
//# sourceMappingURL=data:application/json;base64,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aEQsUUFBTSxHQUFOLENBQVUsNkJBQVYsRUFEZ0Q7QUFFaEQsTUFBSSxlQUFlLE1BQU0sc0JBQU4sQ0FGNkI7QUFHaEQsT0FBSyxJQUFJLEtBQUosSUFBYSxZQUFsQixFQUFnQztBQUMvQixTQUFNLGtCQUFrQixLQUFsQixFQUF3QixPQUF4QixDQUFOLENBRCtCO0dBQWhDO0VBSE07O2lCQUFlIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXHJcbi8vIENvcHlyaWdodCAyMDE2IE5ldCBhdCBXb3JrIEdtYkhcclxuLy9cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxuLy8geW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG4vLyBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuLy9cclxuLy9cdCBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuLy9cclxuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4vLyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbi8vIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4vLyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbi8vIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG5sZXQgUHJvbWlzZSA9IHJlcXVpcmUoJ3JzdnAnKS5Qcm9taXNlO1xyXG5sZXQgYXNwID0gcmVxdWlyZSgncnN2cCcpLmRlbm9kZWlmeTtcclxubGV0IGZzID0gcmVxdWlyZSgnZ3JhY2VmdWwtZnMnKTtcclxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmxldCBndXRpbCA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpO1xyXG5sZXQgc3Bhd24gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuc3Bhd247XHJcblxyXG5sZXQgZGVwZW5kZW5jeVBhdGggPSAnanNwbV9wYWNrYWdlcy9sb2NhbCc7XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRQYWNrYWdlT2JqZWN0KHBhY2thZ2VGaWxlKSB7XHJcblx0dHJ5IHtcclxuXHRcdGxldCBsb29rdXBKU09OID0gYXdhaXQgYXNwKGZzLnJlYWRGaWxlKShwYWNrYWdlRmlsZSk7XHJcblx0XHRyZXR1cm4gSlNPTi5wYXJzZShsb29rdXBKU09OLnRvU3RyaW5nKCkpO1xyXG5cdH1cclxuXHRjYXRjaCAoZSkge1xyXG5cdFx0aWYgKGUuY29kZSA9PSAnRU5PRU5UJyB8fCBlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpXHJcblx0XHRcdHJldHVybiB7IG5vdGZvdW5kOiB0cnVlIH07XHJcblx0XHR0aHJvdyBlO1xyXG5cdH1cclxufVxyXG5cclxuZnVuY3Rpb24gZmlsZUV4aXN0cyAoZmlsZXBhdGgpIHtcclxuXHRpZiAoIWZpbGVwYXRoKSByZXR1cm4gZmFsc2VcclxuXHJcblx0dHJ5IHtcclxuXHRcdHJldHVybiBmcy5zdGF0U3luYyhmaWxlcGF0aCkuaXNGaWxlKCk7XHJcblx0fSBjYXRjaCAoZSkge1xyXG5cdFx0cmV0dXJuIGZhbHNlO1xyXG5cdH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0RlcGVuZGVuY3kocGFja2FnZVBhdGgsIG9wdGlvbnMpIHtcclxuXHRsZXQgcGFja2FnZU5hbWUgPSBwYWNrYWdlUGF0aC5zdWJzdHJpbmcoMCwgcGFja2FnZVBhdGguaW5kZXhPZignQCcpKTtcclxuXHRndXRpbC5sb2coXCJDb21waWxpbmcgcGFja2FnZVwiLCBndXRpbC5jb2xvcnMueWVsbG93KHBhY2thZ2VOYW1lKSk7XHJcblxyXG5cdGxldCBwcm9qZWN0ID0gYXdhaXQgZ2V0UGFja2FnZU9iamVjdChwYXRoLnJlc29sdmUoJy4uJywgcGF0aC5qb2luKHBhY2thZ2VOYW1lLCAncGFja2FnZS5qc29uJykpKTtcclxuXHRsZXQgcHJvamVjdFBhdGggPSBwYXRoLnJlc29sdmUocGF0aC5qb2luKFwiLi5cIiwgcGFja2FnZU5hbWUpKTtcclxuXHJcblx0bGV0IG5wbUluc3RhbGwgPSAob3B0aW9ucyAmJiBvcHRpb25zLm5wbUluc3RhbGwpIHx8dHJ1ZTtcclxuXHRsZXQganNwbUluc3RhbGwgPSAob3B0aW9ucyAmJiBvcHRpb25zLmpzcG1JbnN0YWxsKSB8fCB0cnVlO1xyXG5cdGxldCBndWxwQnVpbGQgPSAob3B0aW9ucyAmJiBvcHRpb25zLmd1bHBCdWlsZCkgfHwgdHJ1ZTtcclxuXHJcblx0aWYobnBtSW5zdGFsbCkge1xyXG5cdFx0YXdhaXQgZXhlY3V0ZU5wbShwcm9qZWN0UGF0aCwgXCJpbnN0YWxsXCIpO1xyXG5cdH1cclxuXHJcblx0bGV0IGlzSnNwbVByZXNlbnQgPSBwcm9qZWN0LmRldkRlcGVuZGVuY2llcyAhPT0gdW5kZWZpbmVkICYmIHByb2plY3QuZGV2RGVwZW5kZW5jaWVzW1wianNwbVwiXSAhPSBudWxsO1xyXG5cdGlmIChqc3BtSW5zdGFsbCAmJiBpc0pzcG1QcmVzZW50KSB7XHJcblx0XHRndXRpbC5sb2coZ3V0aWwuY29sb3JzLnllbGxvdyhcImpzcG1cIiksIFwiaXMgY29uZmlndXJlZCBpbiB0aGlzIHBhY2thZ2UuIFJ1bm5pbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcImpzcG0gaW5zdGFsbFwiKSk7XHJcblx0XHRhd2FpdCBleGVjdXRlSnNwbShwcm9qZWN0UGF0aCk7XHJcblx0fVxyXG5cclxuXHRpZiAoZ3VscEJ1aWxkICYmIGZpbGVFeGlzdHMocGF0aC5qb2luKHByb2plY3RQYXRoLCBcImd1bHBmaWxlLmpzXCIpKSkge1xyXG5cdFx0Z3V0aWwubG9nKGd1dGlsLmNvbG9ycy55ZWxsb3coXCJndWxwXCIpLCBcImlzIGNvbmZpZ3VyZWQgaW4gdGhpcyBwYWNrYWdlLiBSdW5uaW5nXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3coXCJndWxwIGJ1aWxkXCIpKTtcclxuXHRcdGF3YWl0IGV4ZWN1dGVHdWxwKHByb2plY3RQYXRoKTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleGVjdXRlR3VscChwYWNrYWdlUGF0aCwgdGFza3MpIHtcclxuXHRndXRpbC5sb2coXCJQcm9jZXNzaW5nXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3coXCJndWxwXCIpLCBcImZvclwiLCBndXRpbC5jb2xvcnMueWVsbG93KHBhY2thZ2VQYXRoKSk7XHJcblx0cmV0dXJuIHNwYXduUHJvY2VzcyhcImd1bHBcIiwgcGFja2FnZVBhdGgsIHRhc2tzIHx8IFtcImJ1aWxkXCJdKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVKc3BtKHBhY2thZ2VQYXRoKSB7XHJcblx0Z3V0aWwubG9nKFwiUHJvY2Vzc2luZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwianNwbVwiKSwgXCJmb3JcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhwYWNrYWdlUGF0aCkpO1xyXG5cdHJldHVybiBzcGF3blByb2Nlc3MoXCJqc3BtXCIsIHBhY2thZ2VQYXRoIHx8IHBhdGgucmVzb2x2ZShcIi5cIiksIFtcImluc3RhbGxcIl0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZU5wbShwYWNrYWdlUGF0aCwgYWN0aW9uKSB7XHJcblx0Z3V0aWwubG9nKFwiUHJvY2Vzc2luZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwibnBtXCIpLCBcImZvclwiLCBndXRpbC5jb2xvcnMueWVsbG93KHBhY2thZ2VQYXRoKSk7XHJcblx0cmV0dXJuIHNwYXduUHJvY2VzcyhcIm5wbVwiLCBwYWNrYWdlUGF0aCB8fCBwYXRoLnJlc29sdmUoXCIuXCIpLCBbYWN0aW9uIHx8IFwiaW5zdGFsbFwiXSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNwYXduUHJvY2Vzcyhjb21tYW5kLCB3b3JraW5nRGlyZWN0b3J5LCBhcmdzKSB7XHJcblx0bGV0IHJ1bm5pbmdPbldpbmRvd3MgPSAvXndpbi8udGVzdChwcm9jZXNzLnBsYXRmb3JtKTtcclxuXHRsZXQgbm9kZU1vZHVsZXNQYXRoID0gcGF0aC5qb2luKHdvcmtpbmdEaXJlY3RvcnksICdub2RlX21vZHVsZXMnLCAnLmJpbicpO1xyXG5cdGxldCBlbnZDb3B5ID0ge307XHJcblx0Zm9yIChsZXQgZSBpbiBwcm9jZXNzLmVudikgZW52Q29weVtlXSA9IHByb2Nlc3MuZW52W2VdO1xyXG5cclxuXHRpZiAocnVubmluZ09uV2luZG93cykge1xyXG5cdFx0ZW52Q29weS5QYXRoICs9ICc7JyArIG5vZGVNb2R1bGVzUGF0aDtcclxuXHR9IGVsc2Uge1xyXG5cdFx0ZW52Q29weS5QQVRIICs9ICc6JyArIG5vZGVNb2R1bGVzUGF0aDtcclxuXHR9XHJcblxyXG5cdGxldCBvcHRzID0ge1xyXG5cdFx0Y3dkOiB3b3JraW5nRGlyZWN0b3J5LFxyXG5cdFx0ZW52OiBlbnZDb3B5LFxyXG5cdFx0c3RkaW86ICdpbmhlcml0JyxcclxuXHRcdHN0ZGVycjogJ2luaGVyaXQnXHJcblx0fVxyXG5cdGxldCBjb21tYW5kVG9FeGVjdXRlID0gY29tbWFuZDtcclxuXHJcblx0aWYgKHJ1bm5pbmdPbldpbmRvd3MpIHtcclxuXHRcdGFyZ3MgPSBbJy9zJywgJy9jJyxcdGNvbW1hbmQgKyBcIi5jbWRcIl0uY29uY2F0KGFyZ3MpO1xyXG5cdFx0Y29tbWFuZFRvRXhlY3V0ZSA9ICdjbWQnO1xyXG5cclxuXHRcdG9wdHMud2luZG93c1ZlcmJhdGltQXJndW1lbnRzID0gdHJ1ZTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblx0XHRsZXQgcHJvYyA9IHNwYXduKGNvbW1hbmRUb0V4ZWN1dGUsIGFyZ3MsIG9wdHMpO1xyXG5cdFx0cHJvYy5vbignY2xvc2UnLCBmdW5jdGlvbihjb2RlKSB7XHJcblx0XHRcdGxldCBlcnJvcjtcclxuXHJcblx0XHRcdGlmIChjb2RlID09IDApIHtcclxuXHRcdFx0XHRyZXNvbHZlKCk7XHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHR9XHJcblx0XHRcdGVycm9yID0gbmV3IGd1dGlsLlBsdWdpbkVycm9yKGAke2NvbW1hbmR9IG9uICR7cGFja2FnZVBhdGh9IHJldHVybmVkICR7Y29kZX1gKTtcclxuXHRcdFx0cmVqZWN0KGVycm9yKTtcclxuXHRcdH0pO1xyXG5cdH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0RpcmVjdG9yeShmaWxlTmFtZSkge1xyXG5cdGxldCBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShkZXBlbmRlbmN5UGF0aCwgZmlsZU5hbWUpO1xyXG5cdHJldHVybiBmcy5sc3RhdFN5bmMoZmlsZVBhdGgpLmlzRGlyZWN0b3J5KCk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldExvY2FsRGVwZW5kZW5jaWVzKCkge1xyXG5cdGxldCBwYWNrYWdlQ29uZmlnID0gYXdhaXQgZ2V0UGFja2FnZU9iamVjdChcInBhY2thZ2UuanNvblwiKTtcclxuXHJcblx0aWYgKCFwYWNrYWdlQ29uZmlnLmpzcG0gfHwgIXBhY2thZ2VDb25maWcuanNwbS5kZXBlbmRlbmNpZXMpIHRocm93IFwicGFja2FnZS5qc29uIGRvZXMgaGF2ZSBqc3BtIGNvbmZpZ3VyZWQuXCI7XHJcblxyXG5cdGxldCBsb2NhbERlcGVkZW5jaWVzID0gW107XHJcblxyXG5cdHZhciBkZXBlbmRlbmNpZXMgPSBwYWNrYWdlQ29uZmlnLmpzcG0uZGVwZW5kZW5jaWVzO1xyXG5cdGZvciAobGV0IGRlcGVuZGVuY3kgaW4gZGVwZW5kZW5jaWVzKVxyXG5cdHtcclxuXHRcdHZhciB2YWx1ZSA9IGRlcGVuZGVuY2llc1tkZXBlbmRlbmN5XTtcclxuXHRcdGlmICh2YWx1ZS5pbmRleE9mKFwibG9jYWw6XCIpID09IDApIHtcclxuXHRcdFx0bG9jYWxEZXBlZGVuY2llcy5wdXNoKHZhbHVlLnN1YnN0cmluZyhcImxvY2FsOlwiLmxlbmd0aCkpXHJcblx0XHR9XHJcblx0fVxyXG5cdHJldHVybiBsb2NhbERlcGVkZW5jaWVzO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGREZXBlbmRlbmNpZXMob3B0aW9ucykge1xyXG5cdGd1dGlsLmxvZyhcIkJ1aWxkaW5nIGxvY2FsIGRlcGVuZGVuY2llc1wiKTtcclxuXHRsZXQgZGVwZW5kZW5jaWVzID0gYXdhaXQgZ2V0TG9jYWxEZXBlbmRlbmNpZXMoKTtcclxuXHRmb3IgKGxldCBlbnRyeSBvZiBkZXBlbmRlbmNpZXMpIHtcclxuXHRcdGF3YWl0IHByb2Nlc3NEZXBlbmRlbmN5KGVudHJ5LG9wdGlvbnMpO1xyXG5cdH1cclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
