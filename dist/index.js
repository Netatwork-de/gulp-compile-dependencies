'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { return step("next", value); }, function (err) { return step("throw", err); }); } } return step("next"); }); }; }

let Promise = require('rsvp').Promise;
let asp = require('rsvp').denodeify;
let fs = require('graceful-fs');
let path = require('path');
let gutil = require('gulp-util');
let spawn = require('child_process').spawn;

let dependencyPath = 'jspm_packages/local';

let getPackageObjectAsync = function () {
	var ref = _asyncToGenerator(function* (repo) {
		let packageFile = path.resolve('..', path.join(repo, 'package.json'));

		try {
			let lookupJSON = yield asp(fs.readFile)(packageFile);
			return JSON.parse(lookupJSON.toString());
		} catch (e) {
			if (e.code == 'ENOENT' || e instanceof SyntaxError) return { notfound: true };
			throw e;
		}
	});

	return function getPackageObjectAsync(_x) {
		return ref.apply(this, arguments);
	};
}();

function fileExists(filepath) {
	if (!filepath) return false;

	try {
		return fs.statSync(filepath).isFile();
	} catch (e) {
		return false;
	}
}

let processDependencyAsync = function () {
	var ref = _asyncToGenerator(function* (packagePath) {
		let packageName = packagePath.substring(0, packagePath.indexOf('@'));
		gutil.log("Compiling package", gutil.colors.yellow(packageName));

		let project = yield getPackageObjectAsync(packageName);
		let projectPath = path.resolve(path.join("..", packageName));

		yield executeNpmAsync(projectPath, "install");

		let isJspmPresent = project.devDependencies !== undefined && project.devDependencies["jspm"] != null;
		if (isJspmPresent) {
			gutil.log(gutil.colors.yellow("jspm"), "is configured in this package. Running", gutil.colors.yellow("jspm install"));
			yield executeJspmAsync(projectPath);
		}

		if (fileExists(path.join(projectPath, "gulpfile.js"))) {
			gutil.log(gutil.colors.yellow("gulp"), "is configured in this package. Running", gutil.colors.yellow("gulp build"));
			yield executeGulpAsync(projectPath, "build");
		}
	});

	return function processDependencyAsync(_x2) {
		return ref.apply(this, arguments);
	};
}();

function executeGulpAsync(packagePath, tasks) {
	gutil.log("Processing", gutil.colors.yellow("gulp"), "for", gutil.colors.yellow(packagePath));
	return spawnProcessAsync("gulp", packagePath, ["build"]);
}

function executeJspmAsync(packagePath) {
	gutil.log("Processing", gutil.colors.yellow("jspm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcessAsync("jspm", packagePath, ["install"]);
}

function executeNpmAsync(packagePath, action) {
	gutil.log("Processing", gutil.colors.yellow("npm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcessAsync("npm", packagePath, ["install"]);
}

function spawnProcessAsync(command, workingDirectory, args) {
	let runningOnWindows = /^win/.test(process.platform);
	let nodeModulesPath = path.join(workingDirectory, 'node_modules', '.bin');
	let envCopy = {};
	for (let e in process.env) envCopy[e] = process.env[e];

	if (runningOnWindows) {
		envCopy.Path += ';' + nodeModulesPath;
	} else {
		envCopy.PATH += ':' + nodeModulesPath;
	}

	let opts = {
		cwd: workingDirectory,
		env: envCopy,
		stdio: 'inherit',
		stderr: 'inherit'
	};
	let commandToExecute = command;

	if (runningOnWindows) {
		args = ['/s', '/c', command + ".cmd"].concat(args);
		commandToExecute = 'cmd';

		opts.windowsVerbatimArguments = true;
	}

	return new Promise((resolve, reject) => {
		let proc = spawn(commandToExecute, args, opts);
		proc.on('close', function (code) {
			let error;

			if (code == 0) {
				resolve();
				return;
			}
			error = new gutil.PluginError(`${ command } on ${ packagePath } returned ${ code }`);
			reject(error);
		});
	});
}

function isDirectory(fileName) {
	let filePath = path.resolve(dependencyPath, fileName);
	return fs.lstatSync(filePath).isDirectory();
}

let buildDependencies = function () {
	var ref = _asyncToGenerator(function* () {
		gutil.log("Building local dependencies");
		let files = yield asp(fs.readdir)(dependencyPath);
		for (let entry of files) {
			if (isDirectory(entry)) {
				yield processDependencyAsync(entry);
			}
		}
	});

	return function buildDependencies() {
		return ref.apply(this, arguments);
	};
}();

module.exports = buildDependencies;
//# sourceMappingURL=data:application/json;base64,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akIsQ0FGdUM7RUFBckIsQ0FBbkIsQ0EzQjJEO0NBQTVEOztBQTBDQSxTQUFTLFdBQVQsQ0FBcUIsUUFBckIsRUFBK0I7QUFDOUIsS0FBSSxXQUFXLEtBQUssT0FBTCxDQUFhLGNBQWIsRUFBNkIsUUFBN0IsQ0FBWCxDQUQwQjtBQUU5QixRQUFPLEdBQUcsU0FBSCxDQUFhLFFBQWIsRUFBdUIsV0FBdkIsRUFBUCxDQUY4QjtDQUEvQjs7OzZCQUtBLGFBQW1DO0FBQ2xDLFFBQU0sR0FBTixDQUFVLDZCQUFWLEVBRGtDO0FBRWxDLE1BQUksUUFBUSxNQUFNLElBQUksR0FBRyxPQUFILENBQUosQ0FBZ0IsY0FBaEIsQ0FBTixDQUZzQjtBQUdsQyxPQUFLLElBQUksS0FBSixJQUFhLEtBQWxCLEVBQXlCO0FBQ3hCLE9BQUksWUFBWSxLQUFaLENBQUosRUFBd0I7QUFDdkIsVUFBTSx1QkFBdUIsS0FBdkIsQ0FBTixDQUR1QjtJQUF4QjtHQUREO0VBSEQ7O2lCQUFlOzs7OztBQVVmLE9BQU8sT0FBUCxHQUFpQixpQkFBakIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcclxuLy8gQ29weXJpZ2h0IDIwMTYgTmV0IGF0IFdvcmsgR21iSFxyXG4vL1xyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG4vLyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbi8vIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG4vL1xyXG4vL1x0IGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG4vL1xyXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbi8vIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuLy8gV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcbi8vIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuLy8gbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXHJcbmxldCBQcm9taXNlID0gcmVxdWlyZSgncnN2cCcpLlByb21pc2U7XHJcbmxldCBhc3AgPSByZXF1aXJlKCdyc3ZwJykuZGVub2RlaWZ5O1xyXG5sZXQgZnMgPSByZXF1aXJlKCdncmFjZWZ1bC1mcycpO1xyXG5sZXQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxubGV0IGd1dGlsID0gcmVxdWlyZSgnZ3VscC11dGlsJyk7XHJcbmxldCBzcGF3biA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5zcGF3bjtcclxuXHJcbmxldCBkZXBlbmRlbmN5UGF0aCA9ICdqc3BtX3BhY2thZ2VzL2xvY2FsJztcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldFBhY2thZ2VPYmplY3RBc3luYyhyZXBvKSB7XHJcblx0bGV0IHBhY2thZ2VGaWxlID0gcGF0aC5yZXNvbHZlKCcuLicsIHBhdGguam9pbihyZXBvLCAncGFja2FnZS5qc29uJykpO1xyXG5cclxuXHR0cnkge1xyXG5cdFx0bGV0IGxvb2t1cEpTT04gPSBhd2FpdCBhc3AoZnMucmVhZEZpbGUpKHBhY2thZ2VGaWxlKTtcclxuXHRcdHJldHVybiBKU09OLnBhcnNlKGxvb2t1cEpTT04udG9TdHJpbmcoKSk7XHJcblx0fVxyXG5cdGNhdGNoIChlKSB7XHJcblx0XHRpZiAoZS5jb2RlID09ICdFTk9FTlQnIHx8IGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcilcclxuXHRcdFx0cmV0dXJuIHsgbm90Zm91bmQ6IHRydWUgfTtcclxuXHRcdHRocm93IGU7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiBmaWxlRXhpc3RzIChmaWxlcGF0aCkge1xyXG5cdGlmICghZmlsZXBhdGgpIHJldHVybiBmYWxzZVxyXG5cclxuXHR0cnkge1xyXG5cdFx0cmV0dXJuIGZzLnN0YXRTeW5jKGZpbGVwYXRoKS5pc0ZpbGUoKTtcclxuXHR9IGNhdGNoIChlKSB7XHJcblx0XHRyZXR1cm4gZmFsc2U7XHJcblx0fVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzRGVwZW5kZW5jeUFzeW5jKHBhY2thZ2VQYXRoKSB7XHJcblx0bGV0IHBhY2thZ2VOYW1lID0gcGFja2FnZVBhdGguc3Vic3RyaW5nKDAsIHBhY2thZ2VQYXRoLmluZGV4T2YoJ0AnKSk7XHJcblx0Z3V0aWwubG9nKFwiQ29tcGlsaW5nIHBhY2thZ2VcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhwYWNrYWdlTmFtZSkpO1xyXG5cclxuXHRsZXQgcHJvamVjdCA9IGF3YWl0IGdldFBhY2thZ2VPYmplY3RBc3luYyhwYWNrYWdlTmFtZSk7XHJcblx0bGV0IHByb2plY3RQYXRoID0gcGF0aC5yZXNvbHZlKHBhdGguam9pbihcIi4uXCIsIHBhY2thZ2VOYW1lKSk7XHJcblxyXG5cdGF3YWl0IGV4ZWN1dGVOcG1Bc3luYyhwcm9qZWN0UGF0aCwgXCJpbnN0YWxsXCIpO1xyXG5cclxuXHRsZXQgaXNKc3BtUHJlc2VudCA9IHByb2plY3QuZGV2RGVwZW5kZW5jaWVzICE9PSB1bmRlZmluZWQgJiYgcHJvamVjdC5kZXZEZXBlbmRlbmNpZXNbXCJqc3BtXCJdICE9IG51bGw7XHJcblx0aWYgKGlzSnNwbVByZXNlbnQpIHtcclxuXHRcdGd1dGlsLmxvZyhndXRpbC5jb2xvcnMueWVsbG93KFwianNwbVwiKSwgXCJpcyBjb25maWd1cmVkIGluIHRoaXMgcGFja2FnZS4gUnVubmluZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwianNwbSBpbnN0YWxsXCIpKTtcclxuXHRcdGF3YWl0IGV4ZWN1dGVKc3BtQXN5bmMocHJvamVjdFBhdGgpO1xyXG5cdH1cclxuXHJcblx0aWYgKGZpbGVFeGlzdHMocGF0aC5qb2luKHByb2plY3RQYXRoLCBcImd1bHBmaWxlLmpzXCIpKSkge1xyXG5cdFx0Z3V0aWwubG9nKGd1dGlsLmNvbG9ycy55ZWxsb3coXCJndWxwXCIpLCBcImlzIGNvbmZpZ3VyZWQgaW4gdGhpcyBwYWNrYWdlLiBSdW5uaW5nXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3coXCJndWxwIGJ1aWxkXCIpKTtcclxuXHRcdGF3YWl0IGV4ZWN1dGVHdWxwQXN5bmMocHJvamVjdFBhdGgsIFwiYnVpbGRcIik7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiBleGVjdXRlR3VscEFzeW5jKHBhY2thZ2VQYXRoLCB0YXNrcykge1xyXG5cdGd1dGlsLmxvZyhcIlByb2Nlc3NpbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcImd1bHBcIiksIFwiZm9yXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3cocGFja2FnZVBhdGgpKTtcclxuXHRyZXR1cm4gc3Bhd25Qcm9jZXNzQXN5bmMoXCJndWxwXCIsIHBhY2thZ2VQYXRoLCBbXCJidWlsZFwiXSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4ZWN1dGVKc3BtQXN5bmMocGFja2FnZVBhdGgpIHtcclxuXHRndXRpbC5sb2coXCJQcm9jZXNzaW5nXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3coXCJqc3BtXCIpLCBcImZvclwiLCBndXRpbC5jb2xvcnMueWVsbG93KHBhY2thZ2VQYXRoKSk7XHJcblx0cmV0dXJuIHNwYXduUHJvY2Vzc0FzeW5jKFwianNwbVwiLCBwYWNrYWdlUGF0aCwgW1wiaW5zdGFsbFwiXSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4ZWN1dGVOcG1Bc3luYyhwYWNrYWdlUGF0aCwgYWN0aW9uKSB7XHJcblx0Z3V0aWwubG9nKFwiUHJvY2Vzc2luZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwibnBtXCIpLCBcImZvclwiLCBndXRpbC5jb2xvcnMueWVsbG93KHBhY2thZ2VQYXRoKSk7XHJcblx0cmV0dXJuIHNwYXduUHJvY2Vzc0FzeW5jKFwibnBtXCIsIHBhY2thZ2VQYXRoLCBbXCJpbnN0YWxsXCJdKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3Bhd25Qcm9jZXNzQXN5bmMoY29tbWFuZCwgd29ya2luZ0RpcmVjdG9yeSwgYXJncykge1xyXG5cdGxldCBydW5uaW5nT25XaW5kb3dzID0gL153aW4vLnRlc3QocHJvY2Vzcy5wbGF0Zm9ybSk7XHJcblx0bGV0IG5vZGVNb2R1bGVzUGF0aCA9IHBhdGguam9pbih3b3JraW5nRGlyZWN0b3J5LCAnbm9kZV9tb2R1bGVzJywgJy5iaW4nKTtcclxuXHRsZXQgZW52Q29weSA9IHt9O1xyXG5cdGZvciAobGV0IGUgaW4gcHJvY2Vzcy5lbnYpIGVudkNvcHlbZV0gPSBwcm9jZXNzLmVudltlXTtcclxuXHJcblx0aWYgKHJ1bm5pbmdPbldpbmRvd3MpIHtcclxuXHRcdGVudkNvcHkuUGF0aCArPSAnOycgKyBub2RlTW9kdWxlc1BhdGg7XHJcblx0fSBlbHNlIHtcclxuXHRcdGVudkNvcHkuUEFUSCArPSAnOicgKyBub2RlTW9kdWxlc1BhdGg7XHJcblx0fVxyXG5cclxuXHRsZXQgb3B0cyA9IHtcclxuXHRcdGN3ZDogd29ya2luZ0RpcmVjdG9yeSxcclxuXHRcdGVudjogZW52Q29weSxcclxuXHRcdHN0ZGlvOiAnaW5oZXJpdCcsXHJcblx0XHRzdGRlcnI6ICdpbmhlcml0J1xyXG5cdH1cclxuXHRsZXQgY29tbWFuZFRvRXhlY3V0ZSA9IGNvbW1hbmQ7XHJcblxyXG5cdGlmIChydW5uaW5nT25XaW5kb3dzKSB7XHJcblx0XHRhcmdzID0gWycvcycsICcvYycsXHRjb21tYW5kICsgXCIuY21kXCJdLmNvbmNhdChhcmdzKTtcclxuXHRcdGNvbW1hbmRUb0V4ZWN1dGUgPSAnY21kJztcclxuXHJcblx0XHRvcHRzLndpbmRvd3NWZXJiYXRpbUFyZ3VtZW50cyA9IHRydWU7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG5cdFx0bGV0IHByb2MgPSBzcGF3bihjb21tYW5kVG9FeGVjdXRlLCBhcmdzLCBvcHRzKTtcclxuXHRcdHByb2Mub24oJ2Nsb3NlJywgZnVuY3Rpb24oY29kZSkge1xyXG5cdFx0XHRsZXQgZXJyb3I7XHJcblxyXG5cdFx0XHRpZiAoY29kZSA9PSAwKSB7XHJcblx0XHRcdFx0cmVzb2x2ZSgpO1xyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cdFx0XHRlcnJvciA9IG5ldyBndXRpbC5QbHVnaW5FcnJvcihgJHtjb21tYW5kfSBvbiAke3BhY2thZ2VQYXRofSByZXR1cm5lZCAke2NvZGV9YCk7XHJcblx0XHRcdHJlamVjdChlcnJvcik7XHJcblx0XHR9KTtcclxuXHR9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNEaXJlY3RvcnkoZmlsZU5hbWUpIHtcclxuXHRsZXQgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoZGVwZW5kZW5jeVBhdGgsIGZpbGVOYW1lKTtcclxuXHRyZXR1cm4gZnMubHN0YXRTeW5jKGZpbGVQYXRoKS5pc0RpcmVjdG9yeSgpO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBidWlsZERlcGVuZGVuY2llcygpIHtcclxuXHRndXRpbC5sb2coXCJCdWlsZGluZyBsb2NhbCBkZXBlbmRlbmNpZXNcIilcclxuXHRsZXQgZmlsZXMgPSBhd2FpdCBhc3AoZnMucmVhZGRpcikoZGVwZW5kZW5jeVBhdGgpO1xyXG5cdGZvciAobGV0IGVudHJ5IG9mIGZpbGVzKSB7XHJcblx0XHRpZiAoaXNEaXJlY3RvcnkoZW50cnkpKSB7XHJcblx0XHRcdGF3YWl0IHByb2Nlc3NEZXBlbmRlbmN5QXN5bmMoZW50cnkpO1xyXG5cdFx0fVxyXG5cdH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBidWlsZERlcGVuZGVuY2llcztcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
