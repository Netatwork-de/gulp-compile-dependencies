'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.executeGulp = executeGulp;
exports.executeJspm = executeJspm;
exports.executeNpm = executeNpm;

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { return step("next", value); }, function (err) { return step("throw", err); }); } } return step("next"); }); }; }

let Promise = require('rsvp').Promise;
let asp = require('rsvp').denodeify;
let fs = require('graceful-fs');
let path = require('path');
let gutil = require('gulp-util');
let spawn = require('child_process').spawn;

let dependencyPath = 'jspm_packages/local';

let getPackageObject = function () {
	var ref = _asyncToGenerator(function* (packageFile) {
		try {
			let lookupJSON = yield asp(fs.readFile)(packageFile);
			return JSON.parse(lookupJSON.toString());
		} catch (e) {
			if (e.code == 'ENOENT' || e instanceof SyntaxError) return { notfound: true };
			throw e;
		}
	});

	return function getPackageObject(_x) {
		return ref.apply(this, arguments);
	};
}();

function fileExists(filepath) {
	if (!filepath) return false;

	try {
		return fs.statSync(filepath).isFile();
	} catch (e) {
		return false;
	}
}

let processDependency = function () {
	var ref = _asyncToGenerator(function* (packagePath) {
		let packageName = packagePath.substring(0, packagePath.indexOf('@'));
		gutil.log("Compiling package", gutil.colors.yellow(packageName));

		let project = yield getPackageObject(path.resolve('..', path.join(packageName, 'package.json')));
		let projectPath = path.resolve(path.join("..", packageName));

		yield executeNpm(projectPath, "install");

		let isJspmPresent = project.devDependencies !== undefined && project.devDependencies["jspm"] != null;
		if (isJspmPresent) {
			gutil.log(gutil.colors.yellow("jspm"), "is configured in this package. Running", gutil.colors.yellow("jspm install"));
			yield executeJspm(projectPath);
		}

		if (fileExists(path.join(projectPath, "gulpfile.js"))) {
			gutil.log(gutil.colors.yellow("gulp"), "is configured in this package. Running", gutil.colors.yellow("gulp build"));
			yield executeGulp(projectPath);
		}
	});

	return function processDependency(_x2) {
		return ref.apply(this, arguments);
	};
}();

function executeGulp(packagePath, tasks) {
	gutil.log("Processing", gutil.colors.yellow("gulp"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("gulp", packagePath, tasks || ["build"]);
}

function executeJspm(packagePath) {
	gutil.log("Processing", gutil.colors.yellow("jspm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("jspm", packagePath || path.resolve("."), ["install"]);
}

function executeNpm(packagePath, action) {
	gutil.log("Processing", gutil.colors.yellow("npm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("npm", packagePath || path.resolve("."), [action || "install"]);
}

function spawnProcess(command, workingDirectory, args) {
	let runningOnWindows = /^win/.test(process.platform);
	let nodeModulesPath = path.join(workingDirectory, 'node_modules', '.bin');
	let envCopy = {};
	for (let e in process.env) envCopy[e] = process.env[e];

	if (runningOnWindows) {
		envCopy.Path += ';' + nodeModulesPath;
	} else {
		envCopy.PATH += ':' + nodeModulesPath;
	}

	let opts = {
		cwd: workingDirectory,
		env: envCopy,
		stdio: 'inherit',
		stderr: 'inherit'
	};
	let commandToExecute = command;

	if (runningOnWindows) {
		args = ['/s', '/c', command + ".cmd"].concat(args);
		commandToExecute = 'cmd';

		opts.windowsVerbatimArguments = true;
	}

	return new Promise((resolve, reject) => {
		let proc = spawn(commandToExecute, args, opts);
		proc.on('close', function (code) {
			let error;

			if (code == 0) {
				resolve();
				return;
			}
			error = new gutil.PluginError(`${ command } on ${ packagePath } returned ${ code }`);
			reject(error);
		});
	});
}

function isDirectory(fileName) {
	let filePath = path.resolve(dependencyPath, fileName);
	return fs.lstatSync(filePath).isDirectory();
}

let getLocalDependencies = function () {
	var ref = _asyncToGenerator(function* () {
		let packageConfig = yield getPackageObject("package.json");

		if (!packageConfig.jspm || !packageConfig.jspm.dependencies) throw "package.json does have jspm configured.";

		let localDepedencies = [];

		var dependencies = packageConfig.jspm.dependencies;
		for (let dependency in dependencies) {
			var value = dependencies[dependency];
			if (value.indexOf("local:") == 0) {
				localDepedencies.push(value.substring("local:".length));
			}
		}
		return localDepedencies;
	});

	return function getLocalDependencies() {
		return ref.apply(this, arguments);
	};
}();

let buildDependencies = exports.buildDependencies = function () {
	var ref = _asyncToGenerator(function* () {
		gutil.log("Building local dependencies");
		let dependencies = yield getLocalDependencies();
		for (let entry of dependencies) {
			yield processDependency(entry);
		}
	});

	return function buildDependencies() {
		return ref.apply(this, arguments);
	};
}();
//# sourceMappingURL=data:application/json;base64,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MjAxNiBOZXQgYXQgV29yayBHbWJIXHJcbi8vXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbi8vIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuLy8gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbi8vXHJcbi8vXHQgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcbi8vXHJcbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuLy8gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG4vLyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuLy8gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4vLyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cclxubGV0IFByb21pc2UgPSByZXF1aXJlKCdyc3ZwJykuUHJvbWlzZTtcclxubGV0IGFzcCA9IHJlcXVpcmUoJ3JzdnAnKS5kZW5vZGVpZnk7XHJcbmxldCBmcyA9IHJlcXVpcmUoJ2dyYWNlZnVsLWZzJyk7XHJcbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5sZXQgZ3V0aWwgPSByZXF1aXJlKCdndWxwLXV0aWwnKTtcclxubGV0IHNwYXduID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLnNwYXduO1xyXG5cclxubGV0IGRlcGVuZGVuY3lQYXRoID0gJ2pzcG1fcGFja2FnZXMvbG9jYWwnO1xyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2V0UGFja2FnZU9iamVjdChwYWNrYWdlRmlsZSkge1xyXG5cdHRyeSB7XHJcblx0XHRsZXQgbG9va3VwSlNPTiA9IGF3YWl0IGFzcChmcy5yZWFkRmlsZSkocGFja2FnZUZpbGUpO1xyXG5cdFx0cmV0dXJuIEpTT04ucGFyc2UobG9va3VwSlNPTi50b1N0cmluZygpKTtcclxuXHR9XHJcblx0Y2F0Y2ggKGUpIHtcclxuXHRcdGlmIChlLmNvZGUgPT0gJ0VOT0VOVCcgfHwgZSBpbnN0YW5jZW9mIFN5bnRheEVycm9yKVxyXG5cdFx0XHRyZXR1cm4geyBub3Rmb3VuZDogdHJ1ZSB9O1xyXG5cdFx0dGhyb3cgZTtcclxuXHR9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbGVFeGlzdHMgKGZpbGVwYXRoKSB7XHJcblx0aWYgKCFmaWxlcGF0aCkgcmV0dXJuIGZhbHNlXHJcblxyXG5cdHRyeSB7XHJcblx0XHRyZXR1cm4gZnMuc3RhdFN5bmMoZmlsZXBhdGgpLmlzRmlsZSgpO1xyXG5cdH0gY2F0Y2ggKGUpIHtcclxuXHRcdHJldHVybiBmYWxzZTtcclxuXHR9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NEZXBlbmRlbmN5KHBhY2thZ2VQYXRoKSB7XHJcblx0bGV0IHBhY2thZ2VOYW1lID0gcGFja2FnZVBhdGguc3Vic3RyaW5nKDAsIHBhY2thZ2VQYXRoLmluZGV4T2YoJ0AnKSk7XHJcblx0Z3V0aWwubG9nKFwiQ29tcGlsaW5nIHBhY2thZ2VcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhwYWNrYWdlTmFtZSkpO1xyXG5cclxuXHRsZXQgcHJvamVjdCA9IGF3YWl0IGdldFBhY2thZ2VPYmplY3QocGF0aC5yZXNvbHZlKCcuLicsIHBhdGguam9pbihwYWNrYWdlTmFtZSwgJ3BhY2thZ2UuanNvbicpKSk7XHJcblx0bGV0IHByb2plY3RQYXRoID0gcGF0aC5yZXNvbHZlKHBhdGguam9pbihcIi4uXCIsIHBhY2thZ2VOYW1lKSk7XHJcblxyXG5cdGF3YWl0IGV4ZWN1dGVOcG0ocHJvamVjdFBhdGgsIFwiaW5zdGFsbFwiKTtcclxuXHJcblx0bGV0IGlzSnNwbVByZXNlbnQgPSBwcm9qZWN0LmRldkRlcGVuZGVuY2llcyAhPT0gdW5kZWZpbmVkICYmIHByb2plY3QuZGV2RGVwZW5kZW5jaWVzW1wianNwbVwiXSAhPSBudWxsO1xyXG5cdGlmIChpc0pzcG1QcmVzZW50KSB7XHJcblx0XHRndXRpbC5sb2coZ3V0aWwuY29sb3JzLnllbGxvdyhcImpzcG1cIiksIFwiaXMgY29uZmlndXJlZCBpbiB0aGlzIHBhY2thZ2UuIFJ1bm5pbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcImpzcG0gaW5zdGFsbFwiKSk7XHJcblx0XHRhd2FpdCBleGVjdXRlSnNwbShwcm9qZWN0UGF0aCk7XHJcblx0fVxyXG5cclxuXHRpZiAoZmlsZUV4aXN0cyhwYXRoLmpvaW4ocHJvamVjdFBhdGgsIFwiZ3VscGZpbGUuanNcIikpKSB7XHJcblx0XHRndXRpbC5sb2coZ3V0aWwuY29sb3JzLnllbGxvdyhcImd1bHBcIiksIFwiaXMgY29uZmlndXJlZCBpbiB0aGlzIHBhY2thZ2UuIFJ1bm5pbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcImd1bHAgYnVpbGRcIikpO1xyXG5cdFx0YXdhaXQgZXhlY3V0ZUd1bHAocHJvamVjdFBhdGgpO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVHdWxwKHBhY2thZ2VQYXRoLCB0YXNrcykge1xyXG5cdGd1dGlsLmxvZyhcIlByb2Nlc3NpbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcImd1bHBcIiksIFwiZm9yXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3cocGFja2FnZVBhdGgpKTtcclxuXHRyZXR1cm4gc3Bhd25Qcm9jZXNzKFwiZ3VscFwiLCBwYWNrYWdlUGF0aCwgdGFza3MgfHwgW1wiYnVpbGRcIl0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZUpzcG0ocGFja2FnZVBhdGgpIHtcclxuXHRndXRpbC5sb2coXCJQcm9jZXNzaW5nXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3coXCJqc3BtXCIpLCBcImZvclwiLCBndXRpbC5jb2xvcnMueWVsbG93KHBhY2thZ2VQYXRoKSk7XHJcblx0cmV0dXJuIHNwYXduUHJvY2VzcyhcImpzcG1cIiwgcGFja2FnZVBhdGggfHwgcGF0aC5yZXNvbHZlKFwiLlwiKSwgW1wiaW5zdGFsbFwiXSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleGVjdXRlTnBtKHBhY2thZ2VQYXRoLCBhY3Rpb24pIHtcclxuXHRndXRpbC5sb2coXCJQcm9jZXNzaW5nXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3coXCJucG1cIiksIFwiZm9yXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3cocGFja2FnZVBhdGgpKTtcclxuXHRyZXR1cm4gc3Bhd25Qcm9jZXNzKFwibnBtXCIsIHBhY2thZ2VQYXRoIHx8IHBhdGgucmVzb2x2ZShcIi5cIiksIFthY3Rpb24gfHwgXCJpbnN0YWxsXCJdKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3Bhd25Qcm9jZXNzKGNvbW1hbmQsIHdvcmtpbmdEaXJlY3RvcnksIGFyZ3MpIHtcclxuXHRsZXQgcnVubmluZ09uV2luZG93cyA9IC9ed2luLy50ZXN0KHByb2Nlc3MucGxhdGZvcm0pO1xyXG5cdGxldCBub2RlTW9kdWxlc1BhdGggPSBwYXRoLmpvaW4od29ya2luZ0RpcmVjdG9yeSwgJ25vZGVfbW9kdWxlcycsICcuYmluJyk7XHJcblx0bGV0IGVudkNvcHkgPSB7fTtcclxuXHRmb3IgKGxldCBlIGluIHByb2Nlc3MuZW52KSBlbnZDb3B5W2VdID0gcHJvY2Vzcy5lbnZbZV07XHJcblxyXG5cdGlmIChydW5uaW5nT25XaW5kb3dzKSB7XHJcblx0XHRlbnZDb3B5LlBhdGggKz0gJzsnICsgbm9kZU1vZHVsZXNQYXRoO1xyXG5cdH0gZWxzZSB7XHJcblx0XHRlbnZDb3B5LlBBVEggKz0gJzonICsgbm9kZU1vZHVsZXNQYXRoO1xyXG5cdH1cclxuXHJcblx0bGV0IG9wdHMgPSB7XHJcblx0XHRjd2Q6IHdvcmtpbmdEaXJlY3RvcnksXHJcblx0XHRlbnY6IGVudkNvcHksXHJcblx0XHRzdGRpbzogJ2luaGVyaXQnLFxyXG5cdFx0c3RkZXJyOiAnaW5oZXJpdCdcclxuXHR9XHJcblx0bGV0IGNvbW1hbmRUb0V4ZWN1dGUgPSBjb21tYW5kO1xyXG5cclxuXHRpZiAocnVubmluZ09uV2luZG93cykge1xyXG5cdFx0YXJncyA9IFsnL3MnLCAnL2MnLFx0Y29tbWFuZCArIFwiLmNtZFwiXS5jb25jYXQoYXJncyk7XHJcblx0XHRjb21tYW5kVG9FeGVjdXRlID0gJ2NtZCc7XHJcblxyXG5cdFx0b3B0cy53aW5kb3dzVmVyYmF0aW1Bcmd1bWVudHMgPSB0cnVlO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuXHRcdGxldCBwcm9jID0gc3Bhd24oY29tbWFuZFRvRXhlY3V0ZSwgYXJncywgb3B0cyk7XHJcblx0XHRwcm9jLm9uKCdjbG9zZScsIGZ1bmN0aW9uKGNvZGUpIHtcclxuXHRcdFx0bGV0IGVycm9yO1xyXG5cclxuXHRcdFx0aWYgKGNvZGUgPT0gMCkge1xyXG5cdFx0XHRcdHJlc29sdmUoKTtcclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdH1cclxuXHRcdFx0ZXJyb3IgPSBuZXcgZ3V0aWwuUGx1Z2luRXJyb3IoYCR7Y29tbWFuZH0gb24gJHtwYWNrYWdlUGF0aH0gcmV0dXJuZWQgJHtjb2RlfWApO1xyXG5cdFx0XHRyZWplY3QoZXJyb3IpO1xyXG5cdFx0fSk7XHJcblx0fSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRGlyZWN0b3J5KGZpbGVOYW1lKSB7XHJcblx0bGV0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKGRlcGVuZGVuY3lQYXRoLCBmaWxlTmFtZSk7XHJcblx0cmV0dXJuIGZzLmxzdGF0U3luYyhmaWxlUGF0aCkuaXNEaXJlY3RvcnkoKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYWxEZXBlbmRlbmNpZXMoKSB7XHJcblx0bGV0IHBhY2thZ2VDb25maWcgPSBhd2FpdCBnZXRQYWNrYWdlT2JqZWN0KFwicGFja2FnZS5qc29uXCIpO1xyXG5cclxuXHRpZiAoIXBhY2thZ2VDb25maWcuanNwbSB8fCAhcGFja2FnZUNvbmZpZy5qc3BtLmRlcGVuZGVuY2llcykgdGhyb3cgXCJwYWNrYWdlLmpzb24gZG9lcyBoYXZlIGpzcG0gY29uZmlndXJlZC5cIjtcclxuXHJcblx0bGV0IGxvY2FsRGVwZWRlbmNpZXMgPSBbXTtcclxuXHJcblx0dmFyIGRlcGVuZGVuY2llcyA9IHBhY2thZ2VDb25maWcuanNwbS5kZXBlbmRlbmNpZXM7XHJcblx0Zm9yIChsZXQgZGVwZW5kZW5jeSBpbiBkZXBlbmRlbmNpZXMpXHJcblx0e1xyXG5cdFx0dmFyIHZhbHVlID0gZGVwZW5kZW5jaWVzW2RlcGVuZGVuY3ldO1xyXG5cdFx0aWYgKHZhbHVlLmluZGV4T2YoXCJsb2NhbDpcIikgPT0gMCkge1xyXG5cdFx0XHRsb2NhbERlcGVkZW5jaWVzLnB1c2godmFsdWUuc3Vic3RyaW5nKFwibG9jYWw6XCIubGVuZ3RoKSlcclxuXHRcdH1cclxuXHR9XHJcblx0cmV0dXJuIGxvY2FsRGVwZWRlbmNpZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZERlcGVuZGVuY2llcygpIHtcclxuXHRndXRpbC5sb2coXCJCdWlsZGluZyBsb2NhbCBkZXBlbmRlbmNpZXNcIilcclxuXHRsZXQgZGVwZW5kZW5jaWVzID0gYXdhaXQgZ2V0TG9jYWxEZXBlbmRlbmNpZXMoKTtcclxuXHRmb3IgKGxldCBlbnRyeSBvZiBkZXBlbmRlbmNpZXMpIHtcclxuXHRcdGF3YWl0IHByb2Nlc3NEZXBlbmRlbmN5KGVudHJ5KTtcclxuXHR9XHJcbn1cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
