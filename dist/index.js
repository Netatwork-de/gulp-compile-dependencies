'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.executeGulp = executeGulp;
exports.executeJspm = executeJspm;
exports.executeNpm = executeNpm;

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { return step("next", value); }, function (err) { return step("throw", err); }); } } return step("next"); }); }; }

let Promise = require('rsvp').Promise;
let asp = require('rsvp').denodeify;
let fs = require('graceful-fs');
let path = require('path');
let gutil = require('gulp-util');
let spawn = require('child_process').spawn;

let dependencyPath = 'jspm_packages/local';

let getPackageObject = function () {
	var ref = _asyncToGenerator(function* (repo) {
		let packageFile = path.resolve('..', path.join(repo, 'package.json'));

		try {
			let lookupJSON = yield asp(fs.readFile)(packageFile);
			return JSON.parse(lookupJSON.toString());
		} catch (e) {
			if (e.code == 'ENOENT' || e instanceof SyntaxError) return { notfound: true };
			throw e;
		}
	});

	return function getPackageObject(_x) {
		return ref.apply(this, arguments);
	};
}();

function fileExists(filepath) {
	if (!filepath) return false;

	try {
		return fs.statSync(filepath).isFile();
	} catch (e) {
		return false;
	}
}

let processDependency = function () {
	var ref = _asyncToGenerator(function* (packagePath) {
		let packageName = packagePath.substring(0, packagePath.indexOf('@'));
		gutil.log("Compiling package", gutil.colors.yellow(packageName));

		let project = yield getPackageObject(packageName);
		let projectPath = path.resolve(path.join("..", packageName));

		yield executeNpm(projectPath, "install");

		let isJspmPresent = project.devDependencies !== undefined && project.devDependencies["jspm"] != null;
		if (isJspmPresent) {
			gutil.log(gutil.colors.yellow("jspm"), "is configured in this package. Running", gutil.colors.yellow("jspm install"));
			yield executeJspm(projectPath);
		}

		if (fileExists(path.join(projectPath, "gulpfile.js"))) {
			gutil.log(gutil.colors.yellow("gulp"), "is configured in this package. Running", gutil.colors.yellow("gulp build"));
			yield executeGulp(projectPath);
		}
	});

	return function processDependency(_x2) {
		return ref.apply(this, arguments);
	};
}();

function executeGulp(packagePath, tasks) {
	gutil.log("Processing", gutil.colors.yellow("gulp"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("gulp", packagePath, tasks || ["build"]);
}

function executeJspm(packagePath) {
	gutil.log("Processing", gutil.colors.yellow("jspm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("jspm", packagePath || path.resolve("."), ["install"]);
}

function executeNpm(packagePath, action) {
	gutil.log("Processing", gutil.colors.yellow("npm"), "for", gutil.colors.yellow(packagePath));
	return spawnProcess("npm", packagePath || path.resolve("."), [action || "install"]);
}

function spawnProcess(command, workingDirectory, args) {
	let runningOnWindows = /^win/.test(process.platform);
	let nodeModulesPath = path.join(workingDirectory, 'node_modules', '.bin');
	let envCopy = {};
	for (let e in process.env) envCopy[e] = process.env[e];

	if (runningOnWindows) {
		envCopy.Path += ';' + nodeModulesPath;
	} else {
		envCopy.PATH += ':' + nodeModulesPath;
	}

	let opts = {
		cwd: workingDirectory,
		env: envCopy,
		stdio: 'inherit',
		stderr: 'inherit'
	};
	let commandToExecute = command;

	if (runningOnWindows) {
		args = ['/s', '/c', command + ".cmd"].concat(args);
		commandToExecute = 'cmd';

		opts.windowsVerbatimArguments = true;
	}

	return new Promise((resolve, reject) => {
		let proc = spawn(commandToExecute, args, opts);
		proc.on('close', function (code) {
			let error;

			if (code == 0) {
				resolve();
				return;
			}
			error = new gutil.PluginError(`${ command } on ${ packagePath } returned ${ code }`);
			reject(error);
		});
	});
}

function isDirectory(fileName) {
	let filePath = path.resolve(dependencyPath, fileName);
	return fs.lstatSync(filePath).isDirectory();
}

let buildDependencies = exports.buildDependencies = function () {
	var ref = _asyncToGenerator(function* () {
		gutil.log("Building local dependencies");
		let files = yield asp(fs.readdir)(dependencyPath);
		for (let entry of files) {
			if (isDirectory(entry)) {
				yield processDependency(entry);
			}
		}
	});

	return function buildDependencies() {
		return ref.apply(this, arguments);
	};
}();
//# sourceMappingURL=data:application/json;base64,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QyxDQUFwRSxDQUFSLENBUCtCO0FBUS9CLFVBQU8sS0FBUCxFQVIrQjtHQUFmLENBQWpCLENBRnVDO0VBQXJCLENBQW5CLENBM0JzRDtDQUF2RDs7QUEwQ0EsU0FBUyxXQUFULENBQXFCLFFBQXJCLEVBQStCO0FBQzlCLEtBQUksV0FBVyxLQUFLLE9BQUwsQ0FBYSxjQUFiLEVBQTZCLFFBQTdCLENBQVgsQ0FEMEI7QUFFOUIsUUFBTyxHQUFHLFNBQUgsQ0FBYSxRQUFiLEVBQXVCLFdBQXZCLEVBQVAsQ0FGOEI7Q0FBL0I7Ozs2QkFLTyxhQUFtQztBQUN6QyxRQUFNLEdBQU4sQ0FBVSw2QkFBVixFQUR5QztBQUV6QyxNQUFJLFFBQVEsTUFBTSxJQUFJLEdBQUcsT0FBSCxDQUFKLENBQWdCLGNBQWhCLENBQU4sQ0FGNkI7QUFHekMsT0FBSyxJQUFJLEtBQUosSUFBYSxLQUFsQixFQUF5QjtBQUN4QixPQUFJLFlBQVksS0FBWixDQUFKLEVBQXdCO0FBQ3ZCLFVBQU0sa0JBQWtCLEtBQWxCLENBQU4sQ0FEdUI7SUFBeEI7R0FERDtFQUhNOztpQkFBZSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xyXG4vLyBDb3B5cmlnaHQgMjAxNiBOZXQgYXQgV29yayBHbWJIXHJcbi8vXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbi8vIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuLy8gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbi8vXHJcbi8vXHQgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcbi8vXHJcbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuLy8gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG4vLyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuLy8gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4vLyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cclxubGV0IFByb21pc2UgPSByZXF1aXJlKCdyc3ZwJykuUHJvbWlzZTtcclxubGV0IGFzcCA9IHJlcXVpcmUoJ3JzdnAnKS5kZW5vZGVpZnk7XHJcbmxldCBmcyA9IHJlcXVpcmUoJ2dyYWNlZnVsLWZzJyk7XHJcbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5sZXQgZ3V0aWwgPSByZXF1aXJlKCdndWxwLXV0aWwnKTtcclxubGV0IHNwYXduID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLnNwYXduO1xyXG5cclxubGV0IGRlcGVuZGVuY3lQYXRoID0gJ2pzcG1fcGFja2FnZXMvbG9jYWwnO1xyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2V0UGFja2FnZU9iamVjdChyZXBvKSB7XHJcblx0bGV0IHBhY2thZ2VGaWxlID0gcGF0aC5yZXNvbHZlKCcuLicsIHBhdGguam9pbihyZXBvLCAncGFja2FnZS5qc29uJykpO1xyXG5cclxuXHR0cnkge1xyXG5cdFx0bGV0IGxvb2t1cEpTT04gPSBhd2FpdCBhc3AoZnMucmVhZEZpbGUpKHBhY2thZ2VGaWxlKTtcclxuXHRcdHJldHVybiBKU09OLnBhcnNlKGxvb2t1cEpTT04udG9TdHJpbmcoKSk7XHJcblx0fVxyXG5cdGNhdGNoIChlKSB7XHJcblx0XHRpZiAoZS5jb2RlID09ICdFTk9FTlQnIHx8IGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcilcclxuXHRcdFx0cmV0dXJuIHsgbm90Zm91bmQ6IHRydWUgfTtcclxuXHRcdHRocm93IGU7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiBmaWxlRXhpc3RzIChmaWxlcGF0aCkge1xyXG5cdGlmICghZmlsZXBhdGgpIHJldHVybiBmYWxzZVxyXG5cclxuXHR0cnkge1xyXG5cdFx0cmV0dXJuIGZzLnN0YXRTeW5jKGZpbGVwYXRoKS5pc0ZpbGUoKTtcclxuXHR9IGNhdGNoIChlKSB7XHJcblx0XHRyZXR1cm4gZmFsc2U7XHJcblx0fVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzRGVwZW5kZW5jeShwYWNrYWdlUGF0aCkge1xyXG5cdGxldCBwYWNrYWdlTmFtZSA9IHBhY2thZ2VQYXRoLnN1YnN0cmluZygwLCBwYWNrYWdlUGF0aC5pbmRleE9mKCdAJykpO1xyXG5cdGd1dGlsLmxvZyhcIkNvbXBpbGluZyBwYWNrYWdlXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3cocGFja2FnZU5hbWUpKTtcclxuXHJcblx0bGV0IHByb2plY3QgPSBhd2FpdCBnZXRQYWNrYWdlT2JqZWN0KHBhY2thZ2VOYW1lKTtcclxuXHRsZXQgcHJvamVjdFBhdGggPSBwYXRoLnJlc29sdmUocGF0aC5qb2luKFwiLi5cIiwgcGFja2FnZU5hbWUpKTtcclxuXHJcblx0YXdhaXQgZXhlY3V0ZU5wbShwcm9qZWN0UGF0aCwgXCJpbnN0YWxsXCIpO1xyXG5cclxuXHRsZXQgaXNKc3BtUHJlc2VudCA9IHByb2plY3QuZGV2RGVwZW5kZW5jaWVzICE9PSB1bmRlZmluZWQgJiYgcHJvamVjdC5kZXZEZXBlbmRlbmNpZXNbXCJqc3BtXCJdICE9IG51bGw7XHJcblx0aWYgKGlzSnNwbVByZXNlbnQpIHtcclxuXHRcdGd1dGlsLmxvZyhndXRpbC5jb2xvcnMueWVsbG93KFwianNwbVwiKSwgXCJpcyBjb25maWd1cmVkIGluIHRoaXMgcGFja2FnZS4gUnVubmluZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwianNwbSBpbnN0YWxsXCIpKTtcclxuXHRcdGF3YWl0IGV4ZWN1dGVKc3BtKHByb2plY3RQYXRoKTtcclxuXHR9XHJcblxyXG5cdGlmIChmaWxlRXhpc3RzKHBhdGguam9pbihwcm9qZWN0UGF0aCwgXCJndWxwZmlsZS5qc1wiKSkpIHtcclxuXHRcdGd1dGlsLmxvZyhndXRpbC5jb2xvcnMueWVsbG93KFwiZ3VscFwiKSwgXCJpcyBjb25maWd1cmVkIGluIHRoaXMgcGFja2FnZS4gUnVubmluZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwiZ3VscCBidWlsZFwiKSk7XHJcblx0XHRhd2FpdCBleGVjdXRlR3VscChwcm9qZWN0UGF0aCk7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZUd1bHAocGFja2FnZVBhdGgsIHRhc2tzKSB7XHJcblx0Z3V0aWwubG9nKFwiUHJvY2Vzc2luZ1wiLCBndXRpbC5jb2xvcnMueWVsbG93KFwiZ3VscFwiKSwgXCJmb3JcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhwYWNrYWdlUGF0aCkpO1xyXG5cdHJldHVybiBzcGF3blByb2Nlc3MoXCJndWxwXCIsIHBhY2thZ2VQYXRoLCB0YXNrcyB8fCBbXCJidWlsZFwiXSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleGVjdXRlSnNwbShwYWNrYWdlUGF0aCkge1xyXG5cdGd1dGlsLmxvZyhcIlByb2Nlc3NpbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcImpzcG1cIiksIFwiZm9yXCIsIGd1dGlsLmNvbG9ycy55ZWxsb3cocGFja2FnZVBhdGgpKTtcclxuXHRyZXR1cm4gc3Bhd25Qcm9jZXNzKFwianNwbVwiLCBwYWNrYWdlUGF0aCB8fCBwYXRoLnJlc29sdmUoXCIuXCIpLCBbXCJpbnN0YWxsXCJdKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVOcG0ocGFja2FnZVBhdGgsIGFjdGlvbikge1xyXG5cdGd1dGlsLmxvZyhcIlByb2Nlc3NpbmdcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhcIm5wbVwiKSwgXCJmb3JcIiwgZ3V0aWwuY29sb3JzLnllbGxvdyhwYWNrYWdlUGF0aCkpO1xyXG5cdHJldHVybiBzcGF3blByb2Nlc3MoXCJucG1cIiwgcGFja2FnZVBhdGggfHwgcGF0aC5yZXNvbHZlKFwiLlwiKSwgW2FjdGlvbiB8fCBcImluc3RhbGxcIl0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzcGF3blByb2Nlc3MoY29tbWFuZCwgd29ya2luZ0RpcmVjdG9yeSwgYXJncykge1xyXG5cdGxldCBydW5uaW5nT25XaW5kb3dzID0gL153aW4vLnRlc3QocHJvY2Vzcy5wbGF0Zm9ybSk7XHJcblx0bGV0IG5vZGVNb2R1bGVzUGF0aCA9IHBhdGguam9pbih3b3JraW5nRGlyZWN0b3J5LCAnbm9kZV9tb2R1bGVzJywgJy5iaW4nKTtcclxuXHRsZXQgZW52Q29weSA9IHt9O1xyXG5cdGZvciAobGV0IGUgaW4gcHJvY2Vzcy5lbnYpIGVudkNvcHlbZV0gPSBwcm9jZXNzLmVudltlXTtcclxuXHJcblx0aWYgKHJ1bm5pbmdPbldpbmRvd3MpIHtcclxuXHRcdGVudkNvcHkuUGF0aCArPSAnOycgKyBub2RlTW9kdWxlc1BhdGg7XHJcblx0fSBlbHNlIHtcclxuXHRcdGVudkNvcHkuUEFUSCArPSAnOicgKyBub2RlTW9kdWxlc1BhdGg7XHJcblx0fVxyXG5cclxuXHRsZXQgb3B0cyA9IHtcclxuXHRcdGN3ZDogd29ya2luZ0RpcmVjdG9yeSxcclxuXHRcdGVudjogZW52Q29weSxcclxuXHRcdHN0ZGlvOiAnaW5oZXJpdCcsXHJcblx0XHRzdGRlcnI6ICdpbmhlcml0J1xyXG5cdH1cclxuXHRsZXQgY29tbWFuZFRvRXhlY3V0ZSA9IGNvbW1hbmQ7XHJcblxyXG5cdGlmIChydW5uaW5nT25XaW5kb3dzKSB7XHJcblx0XHRhcmdzID0gWycvcycsICcvYycsXHRjb21tYW5kICsgXCIuY21kXCJdLmNvbmNhdChhcmdzKTtcclxuXHRcdGNvbW1hbmRUb0V4ZWN1dGUgPSAnY21kJztcclxuXHJcblx0XHRvcHRzLndpbmRvd3NWZXJiYXRpbUFyZ3VtZW50cyA9IHRydWU7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG5cdFx0bGV0IHByb2MgPSBzcGF3bihjb21tYW5kVG9FeGVjdXRlLCBhcmdzLCBvcHRzKTtcclxuXHRcdHByb2Mub24oJ2Nsb3NlJywgZnVuY3Rpb24oY29kZSkge1xyXG5cdFx0XHRsZXQgZXJyb3I7XHJcblxyXG5cdFx0XHRpZiAoY29kZSA9PSAwKSB7XHJcblx0XHRcdFx0cmVzb2x2ZSgpO1xyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cdFx0XHRlcnJvciA9IG5ldyBndXRpbC5QbHVnaW5FcnJvcihgJHtjb21tYW5kfSBvbiAke3BhY2thZ2VQYXRofSByZXR1cm5lZCAke2NvZGV9YCk7XHJcblx0XHRcdHJlamVjdChlcnJvcik7XHJcblx0XHR9KTtcclxuXHR9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNEaXJlY3RvcnkoZmlsZU5hbWUpIHtcclxuXHRsZXQgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoZGVwZW5kZW5jeVBhdGgsIGZpbGVOYW1lKTtcclxuXHRyZXR1cm4gZnMubHN0YXRTeW5jKGZpbGVQYXRoKS5pc0RpcmVjdG9yeSgpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGREZXBlbmRlbmNpZXMoKSB7XHJcblx0Z3V0aWwubG9nKFwiQnVpbGRpbmcgbG9jYWwgZGVwZW5kZW5jaWVzXCIpXHJcblx0bGV0IGZpbGVzID0gYXdhaXQgYXNwKGZzLnJlYWRkaXIpKGRlcGVuZGVuY3lQYXRoKTtcclxuXHRmb3IgKGxldCBlbnRyeSBvZiBmaWxlcykge1xyXG5cdFx0aWYgKGlzRGlyZWN0b3J5KGVudHJ5KSkge1xyXG5cdFx0XHRhd2FpdCBwcm9jZXNzRGVwZW5kZW5jeShlbnRyeSk7XHJcblx0XHR9XHJcblx0fVxyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
